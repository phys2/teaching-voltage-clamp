/*Copyright (C) 2021 Pierre Kreins  

This program is free software: you can redistribute it and/or modify
it under the terms of the GNU General Public License as published by
the Free Software Foundation, either version 3 of the License, or
(at your option) any later version.

This program is distributed in the hope that it will be useful,
but WITHOUT ANY WARRANTY; without even the implied warranty of
MERCHANTABILITY or FITNESS FOR A PARTICULAR PURPOSE.  See the
GNU General Public License for more details.

You should have received a copy of the GNU General Public License
along with this program.  If not, see <http://www.gnu.org/licenses/>. */
var $jscomp=$jscomp||{};$jscomp.scope={};$jscomp.arrayIteratorImpl=function(b){var a=0;return function(){return a<b.length?{done:!1,value:b[a++]}:{done:!0}}};$jscomp.arrayIterator=function(b){return{next:$jscomp.arrayIteratorImpl(b)}};$jscomp.makeIterator=function(b){var a="undefined"!=typeof Symbol&&Symbol.iterator&&b[Symbol.iterator];return a?a.call(b):$jscomp.arrayIterator(b)};
for(var deltaT=20,dpi=window.devicePixelRatio,maxVolt=120,maxAmp=600,voltOffset=0,ampOffset=0,ivMaxAmp=600,ivY0RelPos=.5,ivX0RelPos=.5,patchStatus=0,bathTimer,wholeCellTimer,ivCurveTimer,voltageClampTimer,passiveTimer,lastDrawnPotX,lastDrawnPotY,lastDrawnCurX,lastDrawnCurY,bathTimerCounter=0,lastPotential=0,ivCurveCounter=0,voltageClampCounter=0,passiveCounter=0,canvasPointsMatrix=[],ivDataMatrix=Array(600),i=0;600>i;++i)ivDataMatrix[i]=[0,0];
var ivMaxPointMatrix=[],ivFittedCurve={},junctionPotentials=[],updateOutputFieldsCounter=0,isDragging=!1;
$(function(){$("#waterBathButton").click(function(){if(0==patchStatus)return patchStatus=1,$("#waterBathButton").attr("disabled","disabled"),$("#wholeCellButton").removeAttr("disabled"),bathTimerCounter=0,$("#simImg").fadeTo(300,.3,function(){$("#simImg").attr("src","ressources/in_bath_framed.svg")}).fadeTo(200,1,function(){bathTimer=setInterval(updateBathReadout,deltaT)}),!1});$("#wholeCellButton").click(function(){if(1==patchStatus)return patchStatus=2,$("#compensate").attr("disabled","disabled"),
$("#wholeCellButton").attr("disabled","disabled"),$("#startRecording").removeAttr("disabled"),clearInterval(bathTimer),$("#simImg").fadeTo(300,.3,function(){$("#simImg").attr("src","ressources/in_oocyte_framed.svg")}).fadeTo(200,1,function(){wholeCellTimer=setInterval(updateWholeCellReadout,deltaT)}),!1});$("#startRecording").click(function(){$("#startRecording").attr("disabled","disabled");2==patchStatus?($("input[name=recordingMode]").attr("disabled","disabled"),$("#stopRecording").removeAttr("disabled"),
clearInterval(wholeCellTimer),canvasPointsMatrix.length=0,"1"==$("input[name=recordingMode]:checked").val()?(patchStatus=3,passiveTimer=setInterval(recordPassive,deltaT),$("#V_mem").attr("readonly","readonly"),$("#v_0Input").attr("readonly","readonly"),$("#deltaVInput").attr("readonly","readonly")):"2"==$("input[name=recordingMode]:checked").val()?(patchStatus=4,voltageClampTimer=setInterval(recordVoltagClamp,deltaT)):(patchStatus=5,ivCurveTimer=setInterval(recordIvCurve,deltaT),$("#V_mem").attr("readonly",
"readonly"),$("#v_0Input").attr("readonly","readonly"),$("#deltaVInput").attr("readonly","readonly"))):3==patchStatus?($("#stopRecording").removeAttr("disabled"),passiveTimer=setInterval(recordPassive,deltaT)):4==patchStatus?($("#stopRecording").removeAttr("disabled"),voltageClampTimer=setInterval(recordVoltagClamp,deltaT)):5==patchStatus&&($("#stopRecording").removeAttr("disabled"),ivCurveTimer=setInterval(recordIvCurve,deltaT))});$("#stopRecording").click(function(){clearInterval(ivCurveTimer);
clearInterval(voltageClampTimer);clearInterval(passiveTimer);$("#stopRecording").attr("disabled","disabled");$("#startRecording").removeAttr("disabled")});$("#importIvData").click(function(){8==patchStatus&&(patchStatus=9,$("#importIvData").attr("disabled","disabled"),$("#analysisScreen").show(),resizeCanvas(),ivFittedCurve.status=0,importIvData())});$("#fitCurve").click(function(){9==patchStatus&&($("#conductanceScreen").show(),resizeCanvas(),fitCurve())});$("#compensate").click(function(){$("#offsetPotentialInput").val((-1*
getJunctionPotential()).toFixed(1))});$("#reboot").click(function(){clearInterval(bathTimer);clearInterval(wholeCellTimer);clearInterval(ivCurveTimer);clearInterval(voltageClampTimer);clearInterval(passiveTimer);passiveCounter=voltageClampCounter=ivCurveCounter=lastPotential=bathTimerCounter=patchStatus=0;$("input[name=recordingMode]").removeAttr("disabled");$("#startRecording").attr("disabled","disabled");$("#stopRecording").attr("disabled","disabled");$("#wholeCellButton").attr("disabled","disabled");
$("#importIvData").attr("disabled","disabled");$("#fitCurve").attr("disabled","disabled");$("#waterBathButton").removeAttr("disabled");$("#compensate").removeAttr("disabled");$("#offsetPotentialInput").val("0");$("#potentialOutput").val("");$("#currentOutput").val("");$("#V_mem").removeAttr("readonly");$("#v_0Input").removeAttr("readonly");$("#deltaVInput").removeAttr("readonly");$("#V_mem").val("-80");$("#v_0Input").val("-90");$("#deltaVInput").val("15");$("#resultBody").html("");$("#resultHeader").hide();
$("#resultBody").hide();$("#Na1").val("150");$("#K1").val("5");$("#Ca1").val("1");$("#Cl1").val("120");$("#Na2").val("150");$("#K2").val("20");$("#Ca2").val("1");$("#Cl2").val("120");$("#simImg").attr("src","ressources/outside_framed.svg");junctionPotentials=[];updateOutputFieldsCounter=0;ivMaxAmp=maxAmp=600;maxVolt=120;ampOffset=voltOffset=0;canvasPointsMatrix=[];ivDataMatrix=Array(600);for(var e=0;600>e;++e)ivDataMatrix[e]=[0,0];ivMaxPointMatrix=[];ivFittedCurve={};resizeCanvas()});document.getElementById("selectedModel").addEventListener("change",
function(){MathJax.typesetClear();"1"==document.getElementById("selectedModel").value?document.getElementById("modelDiv").innerHTML="<p> $$I(U) = a \\cdot U + b$$ </p>":"2"==document.getElementById("selectedModel").value&&(document.getElementById("modelDiv").innerHTML="<p> $$I(U) = \\left(a \\cdot U + b\\right) \\cdot \\left( 1- \\frac{1}{ 1+ e^{\\frac{U-c}{d}} } \\right)$$ </p>");MathJax.typeset([document.getElementById("modelDiv")])});$("#ampZoomIn").click(function(){maxAmp/=2;paintMainCanvas()});
$("#ampZoomOut").click(function(){maxAmp*=2;paintMainCanvas()});$("#voltZoomIn").click(function(){maxVolt/=2;paintMainCanvas()});$("#voltZoomOut").click(function(){maxVolt*=2;paintMainCanvas()});$("#ampOffsetUp").click(function(){--ampOffset;paintMainCanvas()});$("#ampOffsetDown").click(function(){ampOffset+=1;paintMainCanvas()});$("#voltOffsetUp").click(function(){--voltOffset;paintMainCanvas()});$("#voltOffsetDown").click(function(){voltOffset+=1;paintMainCanvas()});$("#ampZoomIvIn").click(function(){ivMaxAmp=
Math.round(ivMaxAmp/2);paintIvCanvas()});$("#ampZoomIvOut").click(function(){ivMaxAmp=Math.round(2*ivMaxAmp);paintIvCanvas()});$("#openModeButton").click(function(){loadOpenMode();$('input:radio[name="displayModeRadio"]').filter('[value="open"]').attr("checked",!0)});$("#hiddenModeButton").click(function(){loadHiddenMode();$('input:radio[name="displayModeRadio"]').filter('[value="hidden"]').attr("checked",!0)});$("input[type=radio][name=displayModeRadio]").change(function(){"open"==this.value?loadOpenMode():
loadHiddenMode()});$("#toggleAmpage").click(function(){$("#ampageCanvas").toggle(600);$(".ampagePositionControlDiv").toggle(600);$("#toggleAmpageExpandText").toggle(600,"linear");$("#ampageScreen").toggleClass("hiddenScreen");$("#toggleAmpageIcon").toggleClass("bi-arrows-collapse");$("#toggleAmpageIcon").toggleClass("bi-arrows-expand")});$("#toggleVoltage").click(function(){$("#voltageCanvas").toggle(600);$(".voltagePositionControlDiv").toggle(600);$("#toggleVoltageExpandText").toggle(600,"linear");
$("#voltageScreen").toggleClass("hiddenScreen");$("#toggleVoltageIcon").toggleClass("bi-arrows-collapse");$("#toggleVoltageIcon").toggleClass("bi-arrows-expand")});document.getElementById("analysisCanvas").addEventListener("mousedown",function(e){isDragging=!0});document.getElementById("analysisCanvas").addEventListener("mousemove",function(e){if(isDragging){var f=e.movementX;e=e.movementY;var h=document.getElementById("analysisCanvas"),k=h.offsetWidth;ivY0RelPos+=e/h.offsetHeight;ivX0RelPos+=f/k;
paintIvCanvas()}});document.getElementById("analysisCanvas").addEventListener("mouseup",function(e){isDragging=!1});document.getElementById("analysisCanvas").addEventListener("mouseout",function(e){isDragging=!1});var b=document.getElementById("collapseBath"),a=document.getElementById("collapseControls"),c=document.getElementById("bathCaret"),d=document.getElementById("controlsCaret");b.addEventListener("hidden.bs.collapse",function(){c.classList.replace("bi-caret-up-fill","bi-caret-down-fill")});
b.addEventListener("shown.bs.collapse",function(){c.classList.replace("bi-caret-down-fill","bi-caret-up-fill")});a.addEventListener("hidden.bs.collapse",function(){d.classList.replace("bi-caret-up-fill","bi-caret-down-fill")});a.addEventListener("shown.bs.collapse",function(){d.classList.replace("bi-caret-down-fill","bi-caret-up-fill")});b=new ResizeObserver(function(e){resizeCanvas()});b.observe(document.getElementById("ampageCanvas"));b.observe(document.getElementById("voltageCanvas"));resizeCanvas();
$(window).on("resize",function(){resizeCanvas()});$(window).on("pageshow",function(){(new bootstrap.Modal(document.getElementById("choiceModal"),{keyboard:!1})).show()});[].slice.call(document.querySelectorAll('[data-bs-toggle="tooltip"]')).map(function(e){return new bootstrap.Tooltip(e)})});
function loadOpenMode(){$("#selectedChannel").html('<option value="1" selected>daueroffen f&uuml;r K&#x207A;</option><option value="2">K&#x1D62;&#x1D63;</option><option value="3">K&#x1D65; (nicht inaktivierend)</option><option value="4">Na&#x1D65; (nicht inaktivierend)</option><option value="5">daueroffen f&uuml;r Na&#x207A;</option><option value="6">daueroffen f&uuml;r Cl&#x207B;</option><option value="7">Ca&#x1D65;</option><option value="8"> K&#x1D65; (inaktivierend)</option><option value="9">Na&#x1D65; (inaktivierend)</option><option value="10">nicht-selektiver Kationenkanal</option>')}
function loadHiddenMode(){$("#selectedChannel").html('<option value="1" selected>unbekannter Kanal 1</option><option value="2">unbekannter Kanal 2</option><option value="3">unbekannter Kanal 3</option><option value="4">unbekannter Kanal 4</option><option value="5">unbekannter Kanal 5</option><option value="6">unbekannter Kanal 6</option><option value="7">unbekannter Kanal 7</option><option value="8">unbekannter Kanal 8</option><option value="9">unbekannter Kanal 9</option><option value="10">unbekannter Kanal 10</option>')}
function importIvData(){for(var b=ivDataMatrix[0][0],a=[],c=$jscomp.makeIterator(ivDataMatrix),d=c.next();!d.done;d=c.next()){var e=d.value;d=e[0];e=e[1];if(!(1>=Math.abs(d-b))){var f=!1;if(0<a.length)for(var h=$jscomp.makeIterator(a),k=h.next();!k.done;k=h.next())if(k=k.value,1>=Math.abs(d-k.referencePotential)){k.currents.push(e);f=!0;break}f||(f={},f.referencePotential=d,f.currents=Array(1),f.currents[0]=e,a.push(f))}}b=$jscomp.makeIterator(a);for(a=b.next();!a.done;a=b.next())a=a.value,c={},c.referencePotential=
a.referencePotential,d=a.currents.indexOf(Math.max.apply(null,a.currents.map(Math.abs))),5>d&&(d=5),c.averageCurrent=average(a.currents.slice(d-5,d+5)),ivMaxPointMatrix.push(c);paintIvCanvas(ivMaxPointMatrix);$("#fitCurve").removeAttr("disabled")}
function fitCurve(){document.getElementById("loadingSpinner").style.display="inline-block";var b=$("#selectedModel").val(),a;"1"==b?a=amd_cf.getEquation("js/line.jseo"):"2"==b&&(a=amd_cf.getEquation("js/nastrommodell.jseo"));a["catch"](function(h){console.error("Something is wrong with the equation:",h)});for(var c=[],d=[],e=$jscomp.makeIterator(ivMaxPointMatrix),f=e.next();!f.done;f=e.next())f=f.value,c.push([f.referencePotential]),d.push(f.averageCurrent);a.fit({x_values:c,y_values:d}).then(function(h){console.log("Done With 1",
h);ivFittedCurve.parameters=h.parameters;"1"==b?(ivFittedCurve.status=1,$("#resultBody").empty().append("<p>$$a = "+ivFittedCurve.parameters[0].toFixed(2)+", b = "+ivFittedCurve.parameters[1].toFixed(2)+"$$</p>")):"2"==b&&(ivFittedCurve.status=2,$("#resultBody").empty().append("<p>$$a = "+ivFittedCurve.parameters[0].toFixed(2)+", b = "+ivFittedCurve.parameters[1].toFixed(2)+", c = "+ivFittedCurve.parameters[2].toFixed(2)+", d = "+ivFittedCurve.parameters[3].toFixed(2)+"$$</p>"));$("#resultHeader").show();
$("#resultBody").show();MathJax.typesetClear();MathJax.typeset([document.getElementById("resultBody")]);h=[];for(var k=[],l=[],g=-200;200>=g;g+=.1)"1"==b?(k.push(lineModel(g,ivFittedCurve.parameters)),l.push(1)):"2"==b&&(k.push(naCurrentModel(g,ivFittedCurve.parameters)),l.push(conductanceModel(g,ivFittedCurve.parameters))),h.push(g);ivFittedCurve.xValues=h;ivFittedCurve.yValues=k;ivFittedCurve.condValues=l;paintIvCanvas();document.getElementById("loadingSpinner").style.display="none"})["catch"](function(h){console.error("1 did not work:",
h)})}
function paintIvCanvas(){var b=document.getElementById("analysisCanvas"),a=b.getContext("2d");a.setTransform(1,0,0,1,0,0);a.scale(dpi,dpi);var c=b.getBoundingClientRect().height;b=b.getBoundingClientRect().width;a.fillStyle="white";a.fillRect(0,0,b,c);a.beginPath();a.lineWidth="1.5";a.strokeStyle="black";a.setLineDash([]);a.moveTo(getIvXValue(b,0,200,ivX0RelPos),0);a.lineTo(getIvXValue(b,0,200,ivX0RelPos),c);a.moveTo(0,getIvYValue(c,0,2*ivMaxAmp,ivY0RelPos));a.lineTo(b,getIvYValue(c,0,2*ivMaxAmp,ivY0RelPos));
a.stroke();var d=Math.round(ivMaxAmp/6);a.setLineDash([2,2]);a.strokeStyle="#6b6b6b";a.lineWidth="1";a.beginPath();a.font="11px Arial";a.fillStyle="black";a.textBaseline="bottom";a.textAlign="center";for(var e=1;21>e;e++){a.moveTo(getIvXValue(b,10*e,200,ivX0RelPos),0);a.lineTo(getIvXValue(b,10*e,200,ivX0RelPos),c-15);var f=(10*e).toString();a.fillText(f,getIvXValue(b,10*e,200,ivX0RelPos),c);0==e%10&&a.fillText("mV",getIvXValue(b,10*e,200,ivX0RelPos),c-12);a.moveTo(getIvXValue(b,-10*e,200,ivX0RelPos),
0);a.lineTo(getIvXValue(b,-10*e,200,ivX0RelPos),c-15);f=(-10*e).toString();a.fillText(f,getIvXValue(b,-10*e,200,ivX0RelPos),c)}a.strokeStyle="black";a.textBaseline="middle";a.textAlign="left";for(e=1;20>e;e++)a.moveTo(0,getIvYValue(c,e*d,2*ivMaxAmp,ivY0RelPos)),a.lineTo(b,getIvYValue(c,e*d,2*ivMaxAmp,ivY0RelPos)),f=(e*d).toString(),0==e%6&&(f+=" nA"),a.fillText(f,0,getIvYValue(c,e*d,2*ivMaxAmp,ivY0RelPos)),a.moveTo(0,getIvYValue(c,-1*e*d,2*ivMaxAmp,ivY0RelPos)),a.lineTo(b,getIvYValue(c,-1*e*d,2*ivMaxAmp,
ivY0RelPos)),f=(-1*e*d).toString(),a.fillText(f,0,getIvYValue(c,-1*e*d,2*ivMaxAmp,ivY0RelPos));a.stroke();d=$jscomp.makeIterator(ivMaxPointMatrix);for(e=d.next();!e.done;e=d.next())e=e.value,a.beginPath(),a.fillStyle="black",a.arc(getIvXValue(b,e.referencePotential,200,ivX0RelPos),getIvYValue(c,e.averageCurrent,2*ivMaxAmp,ivY0RelPos),4,0,2*Math.PI,!1),a.fill();if(0!=ivFittedCurve.status){a.beginPath();a.setLineDash([]);a.strokeStyle="green";a.lineWidth="1.5";a.moveTo(getIvXValue(b,ivFittedCurve.xValues[0],
200,ivX0RelPos),getIvYValue(c,ivFittedCurve.yValues[0],2*ivMaxAmp,ivY0RelPos));for(d=1;d<ivFittedCurve.xValues.length;d++)a.lineTo(getIvXValue(b,ivFittedCurve.xValues[d],200,ivX0RelPos),getIvYValue(c,ivFittedCurve.yValues[d],2*ivMaxAmp,ivY0RelPos));a.stroke();b=document.getElementById("conductanceCanvas");a=b.getContext("2d");a.setTransform(1,0,0,1,0,0);a.scale(dpi,dpi);c=b.getBoundingClientRect().height;b=b.getBoundingClientRect().width;a.clearRect(0,0,b,c);a.strokeStyle="black";a.beginPath();a.lineWidth=
"1.5";a.moveTo(0,getIvYValue(c,0,1.5,.833));a.lineTo(b-30,getIvYValue(c,0,1.5,.833));a.moveTo(0,getIvYValue(c,1,1.5,.833));a.lineTo(b-30,getIvYValue(c,1,1.5,.833));a.moveTo(getIvXValue(b,0,200),getIvYValue(c,1.03,1.5,.833));a.lineTo(getIvXValue(b,0,200),getIvYValue(c,-.03,1.5,.833));a.stroke();a.beginPath();a.setLineDash([1.5,1.5]);a.strokeStyle="#6b6b6b";a.lineWidth="1";a.font="11px Arial";a.textBaseline="top";a.textAlign="center";a.moveTo(0,getIvYValue(c,.25,1.5,.833));a.lineTo(b-30,getIvYValue(c,
.25,1.5,.833));a.moveTo(0,getIvYValue(c,.5,1.5,.833));a.lineTo(b-30,getIvYValue(c,.5,1.5,.833));a.moveTo(0,getIvYValue(c,.75,1.5,.833));a.lineTo(b-30,getIvYValue(c,.75,1.5,.833));a.fillText("0",getIvXValue(b,0,200),getIvYValue(c,-.03,1.5,.833));for(d=1;10>d;d++)a.moveTo(getIvXValue(b,10*d,200),getIvYValue(c,1.03,1.5,.833)),a.lineTo(getIvXValue(b,10*d,200),getIvYValue(c,-.03,1.5,.833)),e=(10*d).toString(),9==d&&(e+=" mV"),a.fillText(e,getIvXValue(b,10*d,200),getIvYValue(c,-.03,1.5,.833)),a.moveTo(getIvXValue(b,
-10*d,200),getIvYValue(c,1.03,1.5,.833)),a.lineTo(getIvXValue(b,-10*d,200),getIvYValue(c,-.03,1.5,.833)),e=(-10*d).toString(),a.fillText(e,getIvXValue(b,-10*d,200),getIvYValue(c,-.03,1.5,.833));a.stroke();a.font="bold 11px Arial";a.textAlign="right";a.textBaseline="middle";a.fillText("0",b,getIvYValue(c,0,1.5,.833));a.fillText("0.25",b,getIvYValue(c,.25,1.5,.833));a.fillText("0.5",b,getIvYValue(c,.5,1.5,.833));a.fillText("0.75",b,getIvYValue(c,.75,1.5,.833));a.fillText("1",b,getIvYValue(c,1,1.5,.833));
a.beginPath();a.strokeStyle="blue";a.setLineDash([]);a.lineWidth="2.5";a.moveTo(getIvXValue(b,ivFittedCurve.xValues[0],200),getIvYValue(c,ivFittedCurve.condValues[0],1.5,.833));for(d=1;d<ivFittedCurve.xValues.length;d++)a.lineTo(getIvXValue(b,ivFittedCurve.xValues[d],200),getIvYValue(c,ivFittedCurve.condValues[d],1.5,.833));a.stroke()}}function getIvXValue(b,a,c,d){return Math.round(a/c*(b-30)+Math.round((b-30)*(void 0===d?.5:d))+15)}
function getIvYValue(b,a,c,d){return Math.round(a/c*-1*(b-30)+Math.round((b-30)*(void 0===d?.5:d))+15)}
function calculateMembranePotential(b){var a=b[0],c=b[1],d=b[2],e=b[3],f=getSelectedIon("Na"),h=getSelectedIon("K"),k=getSelectedIon("Ca"),l=getSelectedIon("Cl");var g=$jscomp.makeIterator(getInternalConcentrations());var m=g.next().value;var n=g.next().value;b=g.next().value;g=g.next().value;f=a*f+c*h+e*g;a=a*m+c*n+e*l;c=d*k;d*=b;return 26.71373*Math.log((f-a+Math.sqrt(Math.pow(f+a,2)+16*(a*c+d*f+4*d*c)))/(2*(a+4*d)))}
function goldmanCurrentEquation(b,a,c,d,e){var f=Math.E,h=96.48533212*-b*c/2577.48341158;return(e-d*Math.pow(f,h))/(1-Math.pow(f,h))*Math.pow(b,2)*Math.pow(96.48533212,2)*c*a/2577.48341158}function useSimpleCurrentModel(){return"simple"==$("input[name='currentSimModeRadio']:checked").val()}
function calculateCurrentForGivenPotential(b,a){var c=a[0],d=a[1],e=a[2],f=a[3],h=getSelectedIon("Na"),k=getSelectedIon("K"),l=getSelectedIon("Ca"),g=getSelectedIon("Cl");var m=$jscomp.makeIterator(getInternalConcentrations());var n=m.next().value;var p=m.next().value;var q=m.next().value;m=m.next().value;if(useSimpleCurrentModel())return c*(b-25.6925775528*Math.log(h/n))+d*(b-25.6925775528*Math.log(k/p))+e*(b-12.8462887764*Math.log(l/q))+f*(b-25.6925775528*Math.log(m/g))+getNoise(4);c=goldmanCurrentEquation(1,
c,b,h,n);d=goldmanCurrentEquation(1,d,b,k,p);f=goldmanCurrentEquation(-1,f,b,g,m);e=goldmanCurrentEquation(2,e,b,l,q);return c+d+f+e+getNoise(4)}
function recordPassive(){var b=timerCounterToTime(passiveCounter),a=getPermeabilities(lastPotential,null),c=calculateMembranePotential(a),d=getJunctionPotential(),e=parseFloat($("#offsetPotentialInput").val()),f=getNoise(.5);lastPotential=c=d+e+f+c;a=calculateCurrentForGivenPotential(c,a);updateOutputFields(c,a);voltageClampCounter==6E4/deltaT?(clearInterval(passiveTimer),patchStatus=6,$("#stopRecording").attr("disabled","disabled")):(passiveCounter++,canvasPointsMatrix.push([b,c,a]),paintMainCanvas())}
function recordVoltagClamp(){var b=timerCounterToTime(voltageClampCounter),a=parseInt($("#V_mem").val()),c=getJunctionPotential(),d=parseFloat($("#offsetPotentialInput").val());c=c+d+a;d=getPermeabilities(a,null);c=calculateCurrentForGivenPotential(c,d);updateOutputFields(a,c);voltageClampCounter==6E4/deltaT?(clearInterval(voltageClampTimer),patchStatus=7,$("#stopRecording").attr("disabled","disabled")):(voltageClampCounter++,canvasPointsMatrix.push([b,a,c]),paintMainCanvas())}
function recordIvCurve(){var b=timerCounterToTime(ivCurveCounter),a=$jscomp.makeIterator(getClampPotential(b)),c=a.next().value;a=a.next().value;var d=getJunctionPotential(),e=parseFloat($("#offsetPotentialInput").val());d=d+e+c;a=getPermeabilities(c,a);a=calculateCurrentForGivenPotential(d,a);updateOutputFields(c,a);ivDataMatrix[ivCurveCounter]=[c,a];ivCurveCounter==6E4/deltaT?(clearInterval(ivCurveTimer),patchStatus=8,$("#stopRecording").attr("disabled","disabled"),$("#importIvData").removeAttr("disabled")):
(ivCurveCounter++,canvasPointsMatrix.push([b,c,a]),paintMainCanvas())}function getClampPotential(b){for(var a=parseInt($("#V_mem").val()),c=parseInt($("#v_0Input").val()),d=parseInt($("#deltaVInput").val()),e=0;11>e&&!(b<5.35*e+3.21);e++)if(b<5.35*(e+1))return[c+e*d,b-(5.35*e+3.21)];return[a,null]}
function updateWholeCellReadout(){var b=timerCounterToTime(bathTimerCounter),a=getPermeabilities(lastPotential,null),c=calculateMembranePotential(a),d=getJunctionPotential(),e=parseFloat($("#offsetPotentialInput").val()),f=getNoise(.5);lastPotential=c=d+e+f+c;a=calculateCurrentForGivenPotential(c,a);updateOutputFields(c,a);bathTimerCounter==6E4/deltaT?(bathTimerCounter=0,canvasPointsMatrix.length=0):(bathTimerCounter++,canvasPointsMatrix.push([b,c,a]),paintMainCanvas())}
function getPermeabilities(b,a){switch($("#selectedChannel").val()){case "1":return useSimpleCurrentModel()?[0,4,0,0]:[0,.03,0,0];case "2":var c=4*(1-1/(1+Math.exp((b- -25)/-4))),d=.86403262,e=0,f=.05,h=10;null!=a&&(d=1/d*(1-1/(1+Math.exp((a-e)/f)))*Math.exp((-a+e)/h),c*=d);useSimpleCurrentModel()||(c*=.0089);return[0,c,0,0];case "3":return c=4*(1-1/(1+Math.exp((b- -50)/4))),useSimpleCurrentModel()||(c*=.0089),[0,c,0,0];case "8":return c=4*(1-1/(1+Math.exp((b- -50)/4))),d=.86403262,e=.05,f=.01,h=
.4,null!=a&&0!=a&&(d=1/d*(1-1/(1+Math.exp((a-e)/f)))*Math.exp((-a+e)/h),c*=d),useSimpleCurrentModel()||(c*=.0089),[0,c,0,0];case "4":return c=4*(1-1/(1+Math.exp((b- -45)/6))),useSimpleCurrentModel()||(c*=.00416),[c,0,0,0];case "9":return c=4*(1-1/(1+Math.exp((b- -45)/6))),d=.86403262,e=.06,f=.01,h=.04,null!=a&&(d=1/d*(1-1/(1+Math.exp((a-e)/f)))*Math.exp((-a+e)/h),c*=d),useSimpleCurrentModel()||(c*=.0043),[c,0,0,0];case "7":return c=3*(1-1/(1+Math.exp((b- -15)/6))),d=.86403262,e=.05,f=.01,h=.6,null!=
a&&(d=1/d*(1-1/(1+Math.exp((a-e)/f)))*Math.exp((-a+e)/h),c*=d),useSimpleCurrentModel()||(c/=2.5),[0,0,c,0];case "6":return useSimpleCurrentModel()?[0,0,0,3]:[0,0,0,.038];case "5":return useSimpleCurrentModel()?[2,0,0,0]:[.0077,0,0,0];case "10":return useSimpleCurrentModel()?[1.5,1,0,0]:[.00463,.003,0,0]}}function getSelectedIon(b){b="#"+b+$("input[name=selectedSolution]:checked").val();return parseFloat($(b).val())}
function updateBathReadout(){var b=timerCounterToTime(bathTimerCounter),a=getJunctionPotential(),c=parseFloat($("#offsetPotentialInput").val()),d=getNoise(.5);lastPotential=a=a+c+d;c=-1*a/.2;updateOutputFields(a,c);bathTimerCounter==6E4/deltaT?(bathTimerCounter=0,canvasPointsMatrix.length=0):(bathTimerCounter++,canvasPointsMatrix.push([b,a,c]),paintMainCanvas())}
function paintMainCanvas(){drawGrid("ampageCanvas",maxAmp," nA",ampOffset);drawGrid("voltageCanvas",maxVolt," mV",voltOffset);1<canvasPointsMatrix.length&&(drawRecord("ampageCanvas",maxAmp,ampOffset,"black",2),drawRecord("voltageCanvas",maxVolt,voltOffset,"red",1))}
function drawRecord(b,a,c,d,e){var f=document.getElementById(b);b=f.getContext("2d");b.setTransform(1,0,0,1,0,0);b.scale(dpi,dpi);var h=f.getBoundingClientRect().height;f=f.getBoundingClientRect().width;b.lineWidth="2";b.setLineDash([]);b.strokeStyle=d;var k=canvasPointsMatrix[0][0],l=canvasPointsMatrix[0][e];k=getRecordXValue(k,60,f);l=getRecordYValue(l,a,c,h,15);b.beginPath();b.moveTo(k,l);for(d=1;d<canvasPointsMatrix.length;d++)k=canvasPointsMatrix[d][0],l=canvasPointsMatrix[d][e],k=getRecordXValue(k,
60,f),l=getRecordYValue(l,a,c,h,15),b.lineTo(k,l);b.stroke()}function getRecordXValue(b,a,c){return Math.round(b/a*c)}function getRecordYValue(b,a,c,d,e){return Math.round(d/2-b/a*(d/2-e)+(d-2*e)/12*c)}
function drawGrid(b,a,c,d){var e=document.getElementById(b);b=e.getContext("2d");b.setTransform(1,0,0,1,0,0);b.scale(dpi,dpi);var f=e.getBoundingClientRect().height;e=e.getBoundingClientRect().width;b.clearRect(0,0,e,f);var h=e/60,k=a/6,l=(f-30)/12;b.strokeStyle="black";b.lineWidth="1.25";b.setLineDash([]);b.beginPath();b.moveTo(h,12);b.lineTo(h,f-12);b.stroke();for(f=0;13>f;f++){var g=a-(f-d)*k,m=Math.round(15+f*l);if(.001>Math.abs(g)){b.strokeStyle="black";b.lineWidth="1.25";b.setLineDash([]);b.beginPath();
b.moveTo(0,m);b.lineTo(e,m);g=m-3;for(var n=m+3,p=2;60>p;p++){var q=Math.round(p*h);b.moveTo(q,g);b.lineTo(q,n)}b.stroke();b.font="13px Arial";b.textBaseline="top";b.textAlign="right";b.fillText("60 s",e-3,m+7)}else b.lineWidth="1",b.setLineDash([4,4]),b.strokeStyle="#8f8f8f",b.beginPath(),b.moveTo(0,m),b.lineTo(e,m),b.stroke(),b.font="13px Arial",b.textBaseline="middle",b.textAlign="left",g=g.toString(),0==f&&(g+=c),b.fillText(g,23,m)}}
function getJunctionPotential(){for(var b=[getSelectedIon("Na"),getSelectedIon("K"),getSelectedIon("Ca"),getSelectedIon("Cl")],a=$jscomp.makeIterator(junctionPotentials),c=a.next();!c.done;c=a.next())if(c=c.value,c.extracellularConcentrations[0]==b[0]&&c.extracellularConcentrations[1]==b[1]&&c.extracellularConcentrations[2]==b[2]&&c.extracellularConcentrations[3]==b[3])return c.potential;return calculateJunctionPotential(b)}
function calculateJunctionPotential(b){for(var a={},c=[0,3E3,0,3E3],d=[1,1,2,-1],e=[.682,1,.81,1.0388],f=0,h=0,k=0,l=0,g=0;4>g;g++)f+=d[g]*d[g]*e[g]*c[g],h+=d[g]*d[g]*e[g]*b[g],k+=d[g]*e[g]*(b[g]-c[g]),l+=d[g]*d[g]*e[g]*(b[g]-c[g]);a.potential=k/l*61.5+Math.log(f/h);a.extracellularConcentrations=b;junctionPotentials.push(a);return a.potential}function getInternalConcentrations(){return[12,155,1E-4,4]}function getNoise(b){return-b+2*Math.random()*b}
function average(b){return b.reduce(function(a,c){return a+c})/b.length}
function resizeCanvas(){var b=document.getElementById("ampageCanvas");b.width=dpi*b.offsetWidth;b.height=dpi*b.offsetHeight;b=document.getElementById("voltageCanvas");b.width=dpi*b.offsetWidth;b.height=dpi*b.offsetHeight;b=document.getElementById("analysisCanvas");b.width=dpi*b.offsetWidth;b.height=dpi*b.offsetHeight;b=document.getElementById("conductanceCanvas");b.width=dpi*b.offsetWidth;b.height=dpi*b.offsetHeight;paintMainCanvas();"undefined"!==typeof ivMaxPointMatrix&&0<ivMaxPointMatrix.length&&
paintIvCanvas()}function timerCounterToTime(b){return b/(6E4/deltaT)*60}function naCurrentModel(b,a){return(a[0]*b+a[1])*conductanceModel(b,a)}function conductanceModel(b,a){return 1-1/(1+Math.exp((b-a[2])/a[3]))}function updateOutputFields(b,a){10<updateOutputFieldsCounter?($("#potentialOutput").val(b.toFixed(1)),$("#currentOutput").val(a.toFixed(0)),updateOutputFieldsCounter=0):updateOutputFieldsCounter++}function lineModel(b,a){return a[0]*b+a[1]};