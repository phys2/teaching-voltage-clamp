/*
 Copyright (C) 2021 Pierre Kreins
 This program is free software: you can redistribute it and/or modify
 it under the terms of the GNU General Public License as published by
 the Free Software Foundation, either version 3 of the License, or
 (at your option) any later version.

 This program is distributed in the hope that it will be useful,
 but WITHOUT ANY WARRANTY; without even the implied warranty of
 MERCHANTABILITY or FITNESS FOR A PARTICULAR PURPOSE.  See the
 GNU General Public License for more details.

 You should have received a copy of the GNU General Public License
 along with this program.  If not, see <http://www.gnu.org/licenses/>.
*/
var $jscomp=$jscomp||{};$jscomp.scope={};$jscomp.arrayIteratorImpl=function(a){var b=0;return function(){return b<a.length?{done:!1,value:a[b++]}:{done:!0}}};$jscomp.arrayIterator=function(a){return{next:$jscomp.arrayIteratorImpl(a)}};$jscomp.makeIterator=function(a){var b="undefined"!=typeof Symbol&&Symbol.iterator&&a[Symbol.iterator];return b?b.call(a):$jscomp.arrayIterator(a)};
for(var deltaT=20,dpi=window.devicePixelRatio,rtfConstant=25.6925775528,maxVolt=120,maxAmp=600,voltOffset=0,ampOffset=0,ivMaxAmp=600,ivY0RelPos=.5,ivX0RelPos=.5,patchStatus=0,bathTimer,wholeCellTimer,ivCurveTimer,voltageClampTimer,passiveTimer,lastDrawnPotX,lastDrawnPotY,lastDrawnCurX,lastDrawnCurY,bathTimerCounter=0,lastPotential=0,ivCurveCounter=0,voltageClampCounter=0,passiveCounter=0,canvasPointsMatrix=[],ivDataMatrix=Array(600),i=0;600>i;++i)ivDataMatrix[i]=[0,0];
var ivMaxPointTotalMatrix=[],ivFittedCurve={},junctionPotentials=[],updateOutputFieldsCounter=0,isDragging=!1;
$(function(){$("#waterBathButton").click(function(){if(0==patchStatus)return patchStatus=1,$("#waterBathButton").attr("disabled","disabled"),$("#wholeCellButton").removeAttr("disabled"),bathTimerCounter=0,$("#simImg").fadeTo(300,.3,function(){$("#simImg").attr("src","ressources/in_bath_framed.svg")}).fadeTo(200,1,function(){bathTimer=setInterval(updateBathReadout,deltaT)}),!1});$("#wholeCellButton").click(function(){if(1==patchStatus)return patchStatus=2,$("#compensate").attr("disabled","disabled"),
$("#wholeCellButton").attr("disabled","disabled"),$("#selectedChannel").attr("disabled","disabled"),$("#startRecording").removeAttr("disabled"),clearInterval(bathTimer),$("#simImg").fadeTo(300,.3,function(){$("#simImg").attr("src","ressources/in_oocyte_framed.svg")}).fadeTo(200,1,function(){wholeCellTimer=setInterval(updateWholeCellReadout,deltaT)}),!1});$("#startRecording").click(function(){$("#startRecording").attr("disabled","disabled");2==patchStatus?($("input[name=recordingMode]").attr("disabled",
"disabled"),$("#stopRecording").removeAttr("disabled"),clearInterval(wholeCellTimer),canvasPointsMatrix.length=0,"1"==$("input[name=recordingMode]:checked").val()?(patchStatus=3,passiveTimer=setInterval(recordPassive,deltaT),$("#V_mem").attr("readonly","readonly"),$("#v_0Input").attr("readonly","readonly"),$("#deltaVInput").attr("readonly","readonly")):"2"==$("input[name=recordingMode]:checked").val()?(patchStatus=4,voltageClampTimer=setInterval(recordVoltagClamp,deltaT)):(patchStatus=5,ivCurveTimer=
setInterval(recordIvCurve,deltaT),$("#V_mem").attr("readonly","readonly"),$("#v_0Input").attr("readonly","readonly"),$("#deltaVInput").attr("readonly","readonly"))):3==patchStatus?($("#stopRecording").removeAttr("disabled"),passiveTimer=setInterval(recordPassive,deltaT)):4==patchStatus?($("#stopRecording").removeAttr("disabled"),voltageClampTimer=setInterval(recordVoltagClamp,deltaT)):5==patchStatus&&($("#stopRecording").removeAttr("disabled"),ivCurveTimer=setInterval(recordIvCurve,deltaT))});$("#stopRecording").click(function(){clearInterval(ivCurveTimer);
clearInterval(voltageClampTimer);clearInterval(passiveTimer);$("#stopRecording").attr("disabled","disabled");$("#startRecording").removeAttr("disabled")});$("#importIvData").click(function(){8==patchStatus&&(patchStatus=9,$("#importIvData").attr("disabled","disabled"),$("#analysisScreen").show(),resizeCanvas(),ivFittedCurve.status=0,importIvData())});$("#fitCurve").click(function(){9==patchStatus&&($("#conductanceScreen").show(),resizeCanvas(),fitCurve())});$("#compensate").click(function(){$("#offsetPotentialInput").val((-1*
getJunctionPotential()).toFixed(1))});$("#reboot").click(function(){clearInterval(bathTimer);clearInterval(wholeCellTimer);clearInterval(ivCurveTimer);clearInterval(voltageClampTimer);clearInterval(passiveTimer);passiveCounter=voltageClampCounter=ivCurveCounter=lastPotential=bathTimerCounter=patchStatus=0;$("input[name=recordingMode]").removeAttr("disabled");$("#startRecording").attr("disabled","disabled");$("#stopRecording").attr("disabled","disabled");$("#wholeCellButton").attr("disabled","disabled");
$("#importIvData").attr("disabled","disabled");$("#waterBathButton").removeAttr("disabled");$("#compensate").removeAttr("disabled");$("#selectedChannel").removeAttr("disabled");$("#offsetPotentialInput").val("0");$("#potentialOutput").val("");$("#currentOutput").val("");$("#V_mem").removeAttr("readonly");$("#v_0Input").removeAttr("readonly");$("#deltaVInput").removeAttr("readonly");$("#V_mem").val("-80");$("#v_0Input").val("-90");$("#deltaVInput").val("15");$("#Na1").val("150");$("#K1").val("5");
$("#Ca1").val("1");$("#Cl1").val("120");$("#Na2").val("150");$("#K2").val("20");$("#Ca2").val("1");$("#Cl2").val("120");$("#simImg").attr("src","ressources/outside_framed.svg");junctionPotentials=[];updateOutputFieldsCounter=0;ivMaxAmp=maxAmp=600;maxVolt=120;ampOffset=voltOffset=0;canvasPointsMatrix=[];ivDataMatrix=Array(600);for(var e=0;600>e;++e)ivDataMatrix[e]=[0,0];resizeCanvas()});document.getElementById("selectedModel").addEventListener("change",function(){MathJax.typesetClear();"1"==document.getElementById("selectedModel").value?
document.getElementById("modelDiv").innerHTML="<p> $$I(U) = a \\cdot U + b$$ </p>":"2"==document.getElementById("selectedModel").value&&(document.getElementById("modelDiv").innerHTML="<p> $$I(U) = \\left(a \\cdot U + b\\right) \\cdot \\left( 1- \\frac{1}{ 1+ e^{\\frac{U-c}{d}} } \\right)$$ </p>");$("#resultHeader").hide();$("#resultBody").hide();MathJax.typeset([document.getElementById("modelDiv")])});$("#ampZoomIn").click(function(){maxAmp/=2;paintMainCanvas()});$("#ampZoomOut").click(function(){maxAmp*=
2;paintMainCanvas()});$("#voltZoomIn").click(function(){maxVolt/=2;paintMainCanvas()});$("#voltZoomOut").click(function(){maxVolt*=2;paintMainCanvas()});$("#ampOffsetUp").click(function(){--ampOffset;paintMainCanvas()});$("#ampOffsetDown").click(function(){ampOffset+=1;paintMainCanvas()});$("#voltOffsetUp").click(function(){--voltOffset;paintMainCanvas()});$("#voltOffsetDown").click(function(){voltOffset+=1;paintMainCanvas()});$("#ampZoomIvIn").click(function(){ivMaxAmp=Math.round(ivMaxAmp/2);paintIvCanvas()});
$("#ampZoomIvOut").click(function(){ivMaxAmp=Math.round(2*ivMaxAmp);paintIvCanvas()});$("#openModeButton").click(function(){loadOpenMode();$('input:radio[name="displayModeRadio"]').filter('[value="open"]').attr("checked",!0)});$("#hiddenModeButton").click(function(){loadHiddenMode();$('input:radio[name="displayModeRadio"]').filter('[value="hidden"]').attr("checked",!0)});$("input[type=radio][name=displayModeRadio]").change(function(){"open"==this.value?loadOpenMode():loadHiddenMode()});$("#toggleAmpage").click(function(){$("#ampageCanvas").toggle(600);
$(".ampagePositionControlDiv").toggle(600);$("#toggleAmpageExpandText").toggle(600,"linear");$("#ampageScreen").toggleClass("hiddenScreen");$("#toggleAmpageIcon").toggleClass("bi-arrows-collapse");$("#toggleAmpageIcon").toggleClass("bi-arrows-expand")});$("#toggleVoltage").click(function(){$("#voltageCanvas").toggle(600);$(".voltagePositionControlDiv").toggle(600);$("#toggleVoltageExpandText").toggle(600,"linear");$("#voltageScreen").toggleClass("hiddenScreen");$("#toggleVoltageIcon").toggleClass("bi-arrows-collapse");
$("#toggleVoltageIcon").toggleClass("bi-arrows-expand")});$("#eraseIvButton").click(function(){$("#eraseIvButton").attr("disabled","disabled");$("#selectedChannelToFit").attr("disabled","disabled");$("#fitCurve").attr("disabled","disabled");ivMaxPointTotalMatrix=[];$("#channelLegend").empty();$("#selectedChannelToFit").empty();$("#selectedChannelToFit").append($("<option>",{value:"NaN",text:"Kanal ausw\u00e4hlen..."}));$("#analysisScreen").hide();$("#conductanceScreen").hide();$("#resultBody").html("");
$("#resultHeader").hide();$("#resultBody").hide();paintIvCanvas()});document.getElementById("analysisCanvas").addEventListener("mousedown",function(e){isDragging=!0});document.getElementById("analysisCanvas").addEventListener("mousemove",function(e){if(isDragging){var f=e.movementX;e=e.movementY;var g=document.getElementById("analysisCanvas"),h=g.offsetWidth;ivY0RelPos+=e/g.offsetHeight;ivX0RelPos+=f/h;paintIvCanvas()}});document.getElementById("analysisCanvas").addEventListener("mouseup",function(e){isDragging=
!1});document.getElementById("analysisCanvas").addEventListener("mouseout",function(e){isDragging=!1});var a=document.getElementById("collapseBath"),b=document.getElementById("collapseControls"),c=document.getElementById("bathCaret"),d=document.getElementById("controlsCaret");a.addEventListener("hidden.bs.collapse",function(){c.classList.replace("bi-caret-up-fill","bi-caret-down-fill")});a.addEventListener("shown.bs.collapse",function(){c.classList.replace("bi-caret-down-fill","bi-caret-up-fill")});
b.addEventListener("hidden.bs.collapse",function(){d.classList.replace("bi-caret-up-fill","bi-caret-down-fill")});b.addEventListener("shown.bs.collapse",function(){d.classList.replace("bi-caret-down-fill","bi-caret-up-fill")});a=new ResizeObserver(function(e){resizeCanvas()});a.observe(document.getElementById("ampageCanvas"));a.observe(document.getElementById("voltageCanvas"));resizeCanvas();$(window).on("resize",function(){resizeCanvas()});$(window).on("pageshow",function(){(new bootstrap.Modal(document.getElementById("choiceModal"),
{keyboard:!1})).show()});[].slice.call(document.querySelectorAll('[data-bs-toggle="tooltip"]')).map(function(e){return new bootstrap.Tooltip(e)})});
function loadOpenMode(){$("#selectedChannel").html('<option value="1" selected>daueroffen f&uuml;r K&#x207A;</option><option value="2">K&#x1D62;&#x1D63;</option><option value="3">K&#x1D65; (nicht inaktivierend)</option><option value="4">Na&#x1D65; (nicht inaktivierend)</option><option value="5">daueroffen f&uuml;r Na&#x207A;</option><option value="6">daueroffen f&uuml;r Cl&#x207B;</option><option value="7">Ca&#x1D65;</option><option value="8"> K&#x1D65; (inaktivierend)</option><option value="9">Na&#x1D65; (inaktivierend)</option><option value="10">nicht-selektiver Kationenkanal</option>')}
function loadHiddenMode(){$("#selectedChannel").html('<option value="1" selected>unbekannter Kanal 1</option><option value="2">unbekannter Kanal 2</option><option value="3">unbekannter Kanal 3</option><option value="4">unbekannter Kanal 4</option><option value="5">unbekannter Kanal 5</option><option value="6">unbekannter Kanal 6</option><option value="7">unbekannter Kanal 7</option><option value="8">unbekannter Kanal 8</option><option value="9">unbekannter Kanal 9</option><option value="10">unbekannter Kanal 10</option>')}
function importIvData(){for(var a=ivDataMatrix[0][0],b=[],c=$jscomp.makeIterator(ivDataMatrix),d=c.next();!d.done;d=c.next()){var e=d.value;d=e[0];e=e[1];if(!(1>=Math.abs(d-a))){var f=!1;if(0<b.length)for(var g=$jscomp.makeIterator(b),h=g.next();!h.done;h=g.next())if(h=h.value,1>=Math.abs(d-h.referencePotential)){h.currents.push(e);f=!0;break}f||(f={},f.referencePotential=d,f.currents=Array(1),f.currents[0]=e,b.push(f))}}a={};channelName=$("#selectedChannel option:selected").text();c=numberOfNameOccurences(channelName);
a.channelName=channelName;0<c&&(c++,a.channelIndex=c,channelName+=" ("+a.channelIndex.toString()+")");a.display=!0;a.values=[];b=$jscomp.makeIterator(b);for(c=b.next();!c.done;c=b.next())c=c.value,d={},d.referencePotential=c.referencePotential,e=c.currents.indexOf(Math.max.apply(null,c.currents.map(Math.abs))),5>e&&(e=5),d.averageCurrent=average(c.currents.slice(e-5,e+5)),a.values.push(d);ivMaxPointTotalMatrix.push(a);paintIvCanvas();$("#fitCurve").removeAttr("disabled");$("#eraseIvButton").removeAttr("disabled");
$("#selectedChannelToFit").append($("<option>",{value:ivMaxPointTotalMatrix.length-1,text:channelName}));"NaN"==$("#selectedChannelToFit").val()&&($("#selectedChannelToFit").children('option[value="NaN"]').remove(),$("#selectedChannelToFit").removeAttr("disabled"))}
function fitCurve(){document.getElementById("loadingSpinner").style.display="inline-block";var a=$("#selectedModel").val(),b=$("#selectedChannelToFit").val(),c;"1"==a?c=amd_cf.getEquation("js/line.jseo"):"2"==a&&(c=amd_cf.getEquation("js/nastrommodell.jseo"));c["catch"](function(h){console.error("Something is wrong with the equation:",h)});for(var d=[],e=[],f=$jscomp.makeIterator(ivMaxPointTotalMatrix[b].values),g=f.next();!g.done;g=f.next())g=g.value,d.push([g.referencePotential]),e.push(g.averageCurrent);
c.fit({x_values:d,y_values:e}).then(function(h){console.log("Done With 1",h);ivMaxPointTotalMatrix[b].parameters=h.parameters;"1"==a?(ivMaxPointTotalMatrix[b].fitStatus=1,$("#resultBody").empty().append("<p>$$a = "+h.parameters[0].toFixed(2)+", b = "+h.parameters[1].toFixed(2)+"$$</p>")):"2"==a&&(ivMaxPointTotalMatrix[b].fitStatus=2,$("#resultBody").empty().append("<p>$$a = "+h.parameters[0].toFixed(2)+", b = "+h.parameters[1].toFixed(2)+", c = "+h.parameters[2].toFixed(2)+", d = "+h.parameters[3].toFixed(2)+
"$$</p>"));$("#resultHeader").show();$("#resultBody").show();MathJax.typesetClear();MathJax.typeset([document.getElementById("resultBody")]);for(var l=[],k=[],m=[],n=-200;200>=n;n+=.1)"1"==a?(k.push(lineModel(n,h.parameters)),m.push(1)):"2"==a&&(k.push(naCurrentModel(n,h.parameters)),m.push(conductanceModel(n,h.parameters))),l.push(n);ivMaxPointTotalMatrix[b].fittedXValues=l;ivMaxPointTotalMatrix[b].fittedYValues=k;ivMaxPointTotalMatrix[b].fittedCondYValues=m;paintIvCanvas();document.getElementById("loadingSpinner").style.display=
"none"})["catch"](function(h){console.error("1 did not work:",h)})}
function paintIvCanvas(){var a=document.getElementById("analysisCanvas"),b=a.getContext("2d");b.setTransform(1,0,0,1,0,0);b.scale(dpi,dpi);var c=a.getBoundingClientRect().height;a=a.getBoundingClientRect().width;var d=document.getElementById("conductanceCanvas"),e=d.getContext("2d");e.setTransform(1,0,0,1,0,0);e.scale(dpi,dpi);condHeight=d.getBoundingClientRect().height;condWidth=d.getBoundingClientRect().width;b.fillStyle="white";b.fillRect(0,0,a,c);b.beginPath();b.lineWidth="1.5";b.strokeStyle=
"black";b.setLineDash([]);b.moveTo(getIvXValue(a,0,200,ivX0RelPos),0);b.lineTo(getIvXValue(a,0,200,ivX0RelPos),c);b.moveTo(0,getIvYValue(c,0,2*ivMaxAmp,ivY0RelPos));b.lineTo(a,getIvYValue(c,0,2*ivMaxAmp,ivY0RelPos));b.stroke();d=Math.round(ivMaxAmp/6);b.setLineDash([2,2]);b.strokeStyle="#6b6b6b";b.lineWidth="1";b.beginPath();b.font="11px Arial";b.fillStyle="black";b.textBaseline="bottom";b.textAlign="center";for(var f=1;21>f;f++){b.moveTo(getIvXValue(a,10*f,200,ivX0RelPos),0);b.lineTo(getIvXValue(a,
10*f,200,ivX0RelPos),c-15);var g=(10*f).toString();b.fillText(g,getIvXValue(a,10*f,200,ivX0RelPos),c);0==f%10&&b.fillText("mV",getIvXValue(a,10*f,200,ivX0RelPos),c-12);b.moveTo(getIvXValue(a,-10*f,200,ivX0RelPos),0);b.lineTo(getIvXValue(a,-10*f,200,ivX0RelPos),c-15);g=(-10*f).toString();b.fillText(g,getIvXValue(a,-10*f,200,ivX0RelPos),c)}b.strokeStyle="black";b.textBaseline="middle";b.textAlign="left";for(f=1;20>f;f++)b.moveTo(0,getIvYValue(c,f*d,2*ivMaxAmp,ivY0RelPos)),b.lineTo(a,getIvYValue(c,f*
d,2*ivMaxAmp,ivY0RelPos)),g=(f*d).toString(),0==f%6&&(g+=" nA"),b.fillText(g,0,getIvYValue(c,f*d,2*ivMaxAmp,ivY0RelPos)),b.moveTo(0,getIvYValue(c,-1*f*d,2*ivMaxAmp,ivY0RelPos)),b.lineTo(a,getIvYValue(c,-1*f*d,2*ivMaxAmp,ivY0RelPos)),g=(-1*f*d).toString(),b.fillText(g,0,getIvYValue(c,-1*f*d,2*ivMaxAmp,ivY0RelPos));b.stroke();drawConductanceGrid();document.getElementById("channelLegend").innerHTML="";d="--bs-green --bs-blue --bs-red --bs-yellow --bs-purple --bs-orange --bs-cyan --bs-pink --bs-teal".split(" ");
for(f=0;f<ivMaxPointTotalMatrix.length;f++){ivMaxPointChannelMatrix=ivMaxPointTotalMatrix[f];g=document.createElement("div");g.classList.add("btn");g.classList.add("btn-sm");g.classList.add("mb-2");g.classList.add("me-2");g.style.setProperty("--channelColor","var("+d[f]+")");var h=ivMaxPointChannelMatrix.display,l=h?" displayed":"",k=ivMaxPointChannelMatrix.channelName;"undefined"!==typeof ivMaxPointChannelMatrix.channelIndex&&(k+=" ("+ivMaxPointChannelMatrix.channelIndex.toString()+")");g.innerHTML=
'<button class="btn btn-sm channelTag'+l+'" onclick="toogleChannelDisplay('+f+')" >'+k+"</button>";document.getElementById("channelLegend").appendChild(g);if(h){g=getComputedStyle(g).getPropertyValue("--channelColor");h=$jscomp.makeIterator(ivMaxPointChannelMatrix.values);for(l=h.next();!l.done;l=h.next())l=l.value,b.beginPath(),b.fillStyle=g,b.arc(getIvXValue(a,l.referencePotential,200,ivX0RelPos),getIvYValue(c,l.averageCurrent,2*ivMaxAmp,ivY0RelPos),4,0,2*Math.PI,!1),b.fill();if("undefined"!==typeof ivMaxPointChannelMatrix.fitStatus){b.beginPath();
b.setLineDash([]);b.strokeStyle=g;b.lineWidth="1.5";b.moveTo(getIvXValue(a,ivMaxPointChannelMatrix.fittedXValues[0],200,ivX0RelPos),getIvYValue(c,ivMaxPointChannelMatrix.fittedYValues[0],2*ivMaxAmp,ivY0RelPos));for(h=1;h<ivMaxPointChannelMatrix.fittedXValues.length;h++)b.lineTo(getIvXValue(a,ivMaxPointChannelMatrix.fittedXValues[h],200,ivX0RelPos),getIvYValue(c,ivMaxPointChannelMatrix.fittedYValues[h],2*ivMaxAmp,ivY0RelPos));b.stroke();e.beginPath();e.strokeStyle=g;e.setLineDash([]);e.lineWidth="2.5";
e.moveTo(getIvXValue(condWidth,ivMaxPointChannelMatrix.fittedXValues[0],200),getIvYValue(condHeight,ivMaxPointChannelMatrix.fittedCondYValues[0],1.5,.833));for(g=1;g<ivMaxPointChannelMatrix.fittedXValues.length;g++)e.lineTo(getIvXValue(condWidth,ivMaxPointChannelMatrix.fittedXValues[g],200),getIvYValue(condHeight,ivMaxPointChannelMatrix.fittedCondYValues[g],1.5,.833));e.stroke()}}}}
function numberOfNameOccurences(a){for(var b=0,c=$jscomp.makeIterator(ivMaxPointTotalMatrix),d=c.next();!d.done;d=c.next())d.value.channelName==a&&b++;return b}
function drawConductanceGrid(){canvas=document.getElementById("conductanceCanvas");ctx=canvas.getContext("2d");ctx.setTransform(1,0,0,1,0,0);ctx.scale(dpi,dpi);height=canvas.getBoundingClientRect().height;width=canvas.getBoundingClientRect().width;ctx.clearRect(0,0,width,height);ctx.strokeStyle="black";ctx.beginPath();ctx.setLineDash([1.5,1.5]);ctx.lineWidth="1.5";ctx.moveTo(0,getIvYValue(height,0,1.5,.833));ctx.lineTo(width-30,getIvYValue(height,0,1.5,.833));ctx.moveTo(0,getIvYValue(height,1,1.5,
.833));ctx.lineTo(width-30,getIvYValue(height,1,1.5,.833));ctx.moveTo(getIvXValue(width,0,200),getIvYValue(height,1.03,1.5,.833));ctx.lineTo(getIvXValue(width,0,200),getIvYValue(height,-.03,1.5,.833));ctx.stroke();ctx.beginPath();ctx.setLineDash([1.5,1.5]);ctx.strokeStyle="#6b6b6b";ctx.lineWidth="1";ctx.font="11px Arial";ctx.textBaseline="top";ctx.textAlign="center";ctx.moveTo(0,getIvYValue(height,.25,1.5,.833));ctx.lineTo(width-30,getIvYValue(height,.25,1.5,.833));ctx.moveTo(0,getIvYValue(height,
.5,1.5,.833));ctx.lineTo(width-30,getIvYValue(height,.5,1.5,.833));ctx.moveTo(0,getIvYValue(height,.75,1.5,.833));ctx.lineTo(width-30,getIvYValue(height,.75,1.5,.833));ctx.fillText("0",getIvXValue(width,0,200),getIvYValue(height,-.03,1.5,.833));for(var a=1;10>a;a++){ctx.moveTo(getIvXValue(width,10*a,200),getIvYValue(height,1.03,1.5,.833));ctx.lineTo(getIvXValue(width,10*a,200),getIvYValue(height,-.03,1.5,.833));var b=(10*a).toString();9==a&&(b+=" mV");ctx.fillText(b,getIvXValue(width,10*a,200),getIvYValue(height,
-.03,1.5,.833));ctx.moveTo(getIvXValue(width,-10*a,200),getIvYValue(height,1.03,1.5,.833));ctx.lineTo(getIvXValue(width,-10*a,200),getIvYValue(height,-.03,1.5,.833));b=(-10*a).toString();ctx.fillText(b,getIvXValue(width,-10*a,200),getIvYValue(height,-.03,1.5,.833))}ctx.stroke();ctx.font="bold 11px Arial";ctx.textAlign="right";ctx.textBaseline="middle";ctx.fillText("0",width,getIvYValue(height,0,1.5,.833));ctx.fillText("0.25",width,getIvYValue(height,.25,1.5,.833));ctx.fillText("0.5",width,getIvYValue(height,
.5,1.5,.833));ctx.fillText("0.75",width,getIvYValue(height,.75,1.5,.833));ctx.fillText("1",width,getIvYValue(height,1,1.5,.833))}function getIvXValue(a,b,c,d){return Math.round(b/c*(a-30)+Math.round((a-30)*(void 0===d?.5:d))+15)}function getIvYValue(a,b,c,d){return Math.round(b/c*-1*(a-30)+Math.round((a-30)*(void 0===d?.5:d))+15)}
function calculateMembranePotential(a){var b=a[0],c=a[1],d=a[2],e=a[3],f=getSelectedIon("Na"),g=getSelectedIon("K"),h=getSelectedIon("Ca"),l=getSelectedIon("Cl");var k=$jscomp.makeIterator(getInternalConcentrations());var m=k.next().value;var n=k.next().value;a=k.next().value;k=k.next().value;f=b*f+c*g+e*k;b=b*m+c*n+e*l;c=d*h;d*=a;return rtfConstant*Math.log((f-b+Math.sqrt(Math.pow(f+b,2)+16*(b*c+d*f+4*d*c)))/(2*(b+4*d)))}
function goldmanCurrentEquation(a,b,c,d,e){var f=Math.E,g=96.48533212*-a*c/2577.48341158;return(e-d*Math.pow(f,g))/(1-Math.pow(f,g))*Math.pow(a,2)*Math.pow(96.48533212,2)*c*b/2577.48341158}function useSimpleCurrentModel(){return"simple"==$("input[name='currentSimModeRadio']:checked").val()}
function calculateCurrentForGivenPotential(a,b){var c=b[0],d=b[1],e=b[2],f=b[3],g=getSelectedIon("Na"),h=getSelectedIon("K"),l=getSelectedIon("Ca"),k=getSelectedIon("Cl");var m=$jscomp.makeIterator(getInternalConcentrations());var n=m.next().value;var p=m.next().value;var q=m.next().value;m=m.next().value;if(useSimpleCurrentModel())return c*(a-calculateMembranePotential([1,0,0,0]))+d*(a-calculateMembranePotential([0,1,0,0]))+e*(a-calculateMembranePotential([0,0,1,0]))+f*(a-calculateMembranePotential([0,
0,0,1]))+getNoise(4);c=goldmanCurrentEquation(1,c,a,g,n);d=goldmanCurrentEquation(1,d,a,h,p);f=goldmanCurrentEquation(-1,f,a,k,m);e=goldmanCurrentEquation(2,e,a,l,q);return c+d+f+e+getNoise(4)}
function recordPassive(){var a=timerCounterToTime(passiveCounter),b=getPermeabilities(lastPotential,null),c=calculateMembranePotential(b),d=getJunctionPotential(),e=parseFloat($("#offsetPotentialInput").val()),f=getNoise(.5);lastPotential=c=d+e+f+c;b=calculateCurrentForGivenPotential(c,b);updateOutputFields(c,b);voltageClampCounter==3E4/deltaT?(clearInterval(passiveTimer),patchStatus=6,$("#stopRecording").attr("disabled","disabled")):(passiveCounter++,canvasPointsMatrix.push([a,c,b]),paintMainCanvas())}
function recordVoltagClamp(){var a=timerCounterToTime(voltageClampCounter),b=parseInt($("#V_mem").val()),c=getJunctionPotential(),d=parseFloat($("#offsetPotentialInput").val());c=c+d+b;d=getPermeabilities(b,null);c=calculateCurrentForGivenPotential(c,d);updateOutputFields(b,c);voltageClampCounter==3E4/deltaT?(clearInterval(voltageClampTimer),patchStatus=7,$("#stopRecording").attr("disabled","disabled")):(voltageClampCounter++,canvasPointsMatrix.push([a,b,c]),paintMainCanvas())}
function recordIvCurve(){var a=timerCounterToTime(ivCurveCounter),b=$jscomp.makeIterator(getClampPotential(a)),c=b.next().value;b=b.next().value;var d=getJunctionPotential(),e=parseFloat($("#offsetPotentialInput").val());d=d+e+c;b=getPermeabilities(c,b);b=calculateCurrentForGivenPotential(d,b);updateOutputFields(c,b);ivDataMatrix[ivCurveCounter]=[c,b];ivCurveCounter==3E4/deltaT?(clearInterval(ivCurveTimer),patchStatus=8,$("#stopRecording").attr("disabled","disabled"),$("#importIvData").removeAttr("disabled")):
(ivCurveCounter++,canvasPointsMatrix.push([a,c,b]),paintMainCanvas())}function getClampPotential(a){for(var b=parseInt($("#V_mem").val()),c=parseInt($("#v_0Input").val()),d=parseInt($("#deltaVInput").val()),e=0;11>e&&!(a<2.6*e+1.5);e++)if(a<2.6*(e+1))return[c+e*d,a-(2.6*e+1.5)];return[b,null]}
function updateWholeCellReadout(){var a=timerCounterToTime(bathTimerCounter),b=getPermeabilities(lastPotential,null),c=calculateMembranePotential(b),d=getJunctionPotential(),e=parseFloat($("#offsetPotentialInput").val()),f=getNoise(.5);lastPotential=c=d+e+f+c;b=calculateCurrentForGivenPotential(c,b);updateOutputFields(c,b);bathTimerCounter==3E4/deltaT?(bathTimerCounter=0,canvasPointsMatrix.length=0):(bathTimerCounter++,canvasPointsMatrix.push([a,c,b]),paintMainCanvas())}
function getPermeabilities(a,b){switch($("#selectedChannel").val()){case "1":return useSimpleCurrentModel()?[0,4,0,0]:[0,.03,0,0];case "2":var c=calculateMembranePotential([0,1,0,0])+60;c=4*(1-1/(1+Math.exp((a-c)/-4)));var d=.86403262,e=0,f=.05,g=10;null!=b&&(d=1/d*(1-1/(1+Math.exp((b-e)/f)))*Math.exp((-b+e)/g),c*=d);useSimpleCurrentModel()||(c*=.0089);return[0,c,0,0];case "3":return c=4*(1-1/(1+Math.exp((a- -50)/4))),useSimpleCurrentModel()||(c*=.0089),[0,c,0,0];case "8":return c=4*(1-1/(1+Math.exp((a-
-50)/4))),d=.86403262,e=.05,f=.01,g=.4,null!=b&&0!=b&&(d=1/d*(1-1/(1+Math.exp((b-e)/f)))*Math.exp((-b+e)/g),c*=d),useSimpleCurrentModel()||(c*=.0089),[0,c,0,0];case "4":return c=4*(1-1/(1+Math.exp((a- -45)/6))),useSimpleCurrentModel()||(c*=.00416),[c,0,0,0];case "9":return c=4*(1-1/(1+Math.exp((a- -45)/6))),d=.86403262,e=.06,f=.01,g=.04,null!=b&&(d=1/d*(1-1/(1+Math.exp((b-e)/f)))*Math.exp((-b+e)/g),c*=d),useSimpleCurrentModel()||(c*=.0043),[c,0,0,0];case "7":return c=3*(1-1/(1+Math.exp((a- -15)/6))),
d=.86403262,e=.05,f=.01,g=.6,null!=b&&(d=1/d*(1-1/(1+Math.exp((b-e)/f)))*Math.exp((-b+e)/g),c*=d),useSimpleCurrentModel()||(c/=2.5),[0,0,c,0];case "6":return useSimpleCurrentModel()?[0,0,0,3]:[0,0,0,.038];case "5":return useSimpleCurrentModel()?[2,0,0,0]:[.0077,0,0,0];case "10":return useSimpleCurrentModel()?[1.5,.8,0,0]:[.00463,.003,0,0]}}function getSelectedIon(a){a="#"+a+$("input[name=selectedSolution]:checked").val();return parseFloat($(a).val())}
function updateBathReadout(){var a=timerCounterToTime(bathTimerCounter),b=getJunctionPotential(),c=parseFloat($("#offsetPotentialInput").val()),d=getNoise(.5);lastPotential=b=b+c+d;c=-1*b/.2;updateOutputFields(b,c);bathTimerCounter==3E4/deltaT?(bathTimerCounter=0,canvasPointsMatrix.length=0):(bathTimerCounter++,canvasPointsMatrix.push([a,b,c]),paintMainCanvas())}
function paintMainCanvas(){drawGrid("ampageCanvas",maxAmp," nA",ampOffset);drawGrid("voltageCanvas",maxVolt," mV",voltOffset);1<canvasPointsMatrix.length&&(drawRecord("ampageCanvas",maxAmp,ampOffset,"black",2),drawRecord("voltageCanvas",maxVolt,voltOffset,"red",1))}
function drawRecord(a,b,c,d,e){var f=document.getElementById(a);a=f.getContext("2d");a.setTransform(1,0,0,1,0,0);a.scale(dpi,dpi);var g=f.getBoundingClientRect().height;f=f.getBoundingClientRect().width;a.lineWidth="2";a.setLineDash([]);a.strokeStyle=d;var h=canvasPointsMatrix[0][0],l=canvasPointsMatrix[0][e];h=getRecordXValue(h,30,f);l=getRecordYValue(l,b,c,g,15);a.beginPath();a.moveTo(h,l);for(d=1;d<canvasPointsMatrix.length;d++)h=canvasPointsMatrix[d][0],l=canvasPointsMatrix[d][e],h=getRecordXValue(h,
30,f),l=getRecordYValue(l,b,c,g,15),a.lineTo(h,l);a.stroke()}function getRecordXValue(a,b,c){return Math.round(a/b*c)}function getRecordYValue(a,b,c,d,e){return Math.round(d/2-a/b*(d/2-e)+(d-2*e)/12*c)}
function drawGrid(a,b,c,d){var e=document.getElementById(a);a=e.getContext("2d");a.setTransform(1,0,0,1,0,0);a.scale(dpi,dpi);var f=e.getBoundingClientRect().height;e=e.getBoundingClientRect().width;a.clearRect(0,0,e,f);var g=e/60,h=b/6,l=(f-30)/12;a.strokeStyle="black";a.lineWidth="1.25";a.setLineDash([]);a.beginPath();a.moveTo(g,12);a.lineTo(g,f-12);a.stroke();for(f=0;13>f;f++){var k=b-(f-d)*h,m=Math.round(15+f*l);if(.001>Math.abs(k)){a.strokeStyle="black";a.lineWidth="1.25";a.setLineDash([]);a.beginPath();
a.moveTo(0,m);a.lineTo(e,m);k=m-3;for(var n=m+3,p=2;60>p;p++){var q=Math.round(p*g);a.moveTo(q,k);a.lineTo(q,n)}a.stroke();a.font="13px Arial";a.textBaseline="top";a.textAlign="right";a.fillText("30 s",e-3,m+7)}else a.lineWidth="1",a.setLineDash([4,4]),a.strokeStyle="#8f8f8f",a.beginPath(),a.moveTo(0,m),a.lineTo(e,m),a.stroke(),a.font="13px Arial",a.textBaseline="middle",a.textAlign="left",k=k.toString(),0==f&&(k+=c),a.fillText(k,23,m)}}
function getJunctionPotential(){for(var a=[getSelectedIon("Na"),getSelectedIon("K"),getSelectedIon("Ca"),getSelectedIon("Cl")],b=$jscomp.makeIterator(junctionPotentials),c=b.next();!c.done;c=b.next())if(c=c.value,c.extracellularConcentrations[0]==a[0]&&c.extracellularConcentrations[1]==a[1]&&c.extracellularConcentrations[2]==a[2]&&c.extracellularConcentrations[3]==a[3])return c.potential;return calculateJunctionPotential(a)}
function calculateJunctionPotential(a){for(var b={},c=[0,3E3,0,3E3],d=[1,1,2,-1],e=[.682,1,.81,1.0388],f=0,g=0,h=0,l=0,k=0;4>k;k++)f+=d[k]*d[k]*e[k]*c[k],g+=d[k]*d[k]*e[k]*a[k],h+=d[k]*e[k]*(a[k]-c[k]),l+=d[k]*d[k]*e[k]*(a[k]-c[k]);b.potential=h/l*rtfConstant+Math.log(f/g);b.extracellularConcentrations=a;junctionPotentials.push(b);return b.potential}function getInternalConcentrations(){return[12,155,1E-4,4]}function getNoise(a){return-a+2*Math.random()*a}
function average(a){return a.reduce(function(b,c){return b+c})/a.length}
function resizeCanvas(){var a=document.getElementById("ampageCanvas");a.width=dpi*a.offsetWidth;a.height=dpi*a.offsetHeight;a=document.getElementById("voltageCanvas");a.width=dpi*a.offsetWidth;a.height=dpi*a.offsetHeight;a=document.getElementById("analysisCanvas");a.width=dpi*a.offsetWidth;a.height=dpi*a.offsetHeight;a=document.getElementById("conductanceCanvas");a.width=dpi*a.offsetWidth;a.height=dpi*a.offsetHeight;paintMainCanvas();"undefined"!==typeof ivMaxPointTotalMatrix&&0<ivMaxPointTotalMatrix.length&&
paintIvCanvas()}function timerCounterToTime(a){return a/(3E4/deltaT)*30}function naCurrentModel(a,b){return(b[0]*a+b[1])*conductanceModel(a,b)}function conductanceModel(a,b){return 1-1/(1+Math.exp((a-b[2])/b[3]))}function updateOutputFields(a,b){10<updateOutputFieldsCounter?($("#potentialOutput").val(a.toFixed(1)),$("#currentOutput").val(b.toFixed(0)),updateOutputFieldsCounter=0):updateOutputFieldsCounter++}function lineModel(a,b){return b[0]*a+b[1]}
function toogleChannelDisplay(a){ivMaxPointTotalMatrix[a].display=!ivMaxPointTotalMatrix[a].display;paintIvCanvas()};